{% comment %}
  Batch Information Block
  Shows batch information for all product variants when available from metafields
{% endcomment %}

{% schema %}
{
  "name": "Batch Information",
  "target": "section",
  "templates": ["product"],
  "settings": []
}
{% endschema %}

<div style="margin: 10px 0; padding: 8px; border: 1px solid #e8e8e8; border-radius: 4px; background-color: #f9f9f9; font-size: 12px;">
  <h3 style="margin: 0 0 6px 0; font-size: 14px; font-weight: 600;">批次資訊</h3>
  
  {% assign has_batch_info = false %}
  
  {% for variant in product.variants %}
    {% if variant.metafields.alpha_dog.expiration_data %}
      {% assign has_batch_info = true %}
      {% assign raw_data = variant.metafields.alpha_dog.expiration_data %}
      
      {% comment %}
        Extract the values from the raw JSON string using string manipulation
        since Liquid has limited JSON parsing capabilities
      {% endcomment %}
      {% assign batch_id_start = raw_data | split: '"batchId":"' | last %}
      {% assign batch_id = batch_id_start | split: '"' | first %}
      
      {% assign quantity_start = raw_data | split: '"quantity":' | last %}
      {% assign quantity = quantity_start | split: ',' | first %}
      
      {% assign location_start = raw_data | split: '"location":"' | last %}
      {% assign location = location_start | split: '"' | first %}
      
      <div style="margin-bottom: 6px; padding-bottom: 6px; {% unless forloop.last %}border-bottom: 1px solid #eee;{% endunless %}">
        <div style="display: flex; flex-wrap: wrap; align-items: center; font-size: 12px;">
          <div style="font-weight: 600; margin-right: 8px; color: #333;">{{ variant.title }}:</div>
          <div style="color: #555; display: flex; flex-wrap: wrap;">
            <div style="margin-right: 8px;"><span style="color: #666;">保存期限:</span> {{ batch_id }}</div>
            <div style="margin-right: 8px;"><span style="color: #666;">庫存:</span> {{ quantity }}</div>
            <div><span style="color: #666;">倉庫:</span> {{ location }}</div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endfor %}
  
  {% if has_batch_info == false %}
    <p style="margin: 0; color: #777; font-style: italic; font-size: 12px;">此產品暫無批次資訊</p>
  {% endif %}
</div>
