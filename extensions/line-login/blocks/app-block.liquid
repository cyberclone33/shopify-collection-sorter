{% comment %}
  Premium Pet Products Carousel by Alpha Dog
  An elegant, high-end carousel display for your premium pet products
{% endcomment %}

<!-- No external CSS needed for simple scroll slider -->

<div id="alpha-dog-carousel" class="alpha-dog-carousel" style="margin: 40px auto; max-width: 1200px; width: 100%; left: 0; right: 0; position: relative;">
  <div class="carousel-container" style="max-width: 1200px; margin: 0 auto; width: 100%; left: 0; right: 0; position: relative;">
    <style>
      /* Main carousel container - exact centering */
      .alpha-dog-carousel{margin:40px auto;overflow:hidden;position:relative;padding:10px 0 30px;max-width:1200px;width:100%;left:0;right:0}
      
      /* Header styling - optimized */
      .carousel-header{text-align:center;margin-bottom:35px;position:relative;z-index:2}
      .carousel-header h2{color:{{ block.settings.heading_color }};font-size:28px;margin-bottom:12px;font-weight:600;letter-spacing:0.02em;position:relative;display:inline-block}
      .carousel-header h2::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:50px;height:2px;background-color:{{ block.settings.heading_color }}}
      .carousel-header p{color:{{ block.settings.subtitle_color }};font-size:15px;max-width:700px;margin:0 auto;line-height:1.5;font-weight:300}
      
      /* Product card design - fixed dimensions for uniformity */
      .product-card,.alpha-dog-product-card{position:relative;width:100%;height:380px !important;min-height:380px !important;max-height:380px !important;background-color:{{ block.settings.card_bg_color }};border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.06);overflow:hidden;transition:all 0.4s cubic-bezier(0.22,1,0.36,1);cursor:pointer;display:flex;flex-direction:column;border:1px solid rgba(240,240,240,0.8);margin:0 auto;box-sizing:border-box}
      
      /* Product image container - square format with consistent sizing */
      .product-image-container{width:100%;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;background-color:{{ block.settings.image_bg_color }};flex:0;margin:0;border-radius:8px 8px 0 0;height:260px !important;min-height:260px !important;max-height:260px !important;aspect-ratio:1/1 !important}
      
      .product-card:hover,.alpha-dog-product-card:hover{transform:translateY(-6px);box-shadow:0 12px 24px rgba(0,0,0,0.08);border-color:rgba(220,220,220,0.8)}
      .product-card:active,.alpha-dog-product-card:active{transform:translateY(-2px);transition:all 0.2s}
      
      .product-image{width:100%;height:260px;position:relative;overflow:hidden;background-color:{{ block.settings.image_bg_color }};flex-shrink:0;display:flex;align-items:center;justify-content:center;padding:10px;transition:all 0.4s ease;aspect-ratio:1/1}
      .product-image img{width:100%;height:100%;object-fit:contain;display:block;transition:transform 0.7s cubic-bezier(0.22,1,0.36,1);max-height:260px;max-width:260px}
      .product-card:hover .product-image img{transform:scale(1.08)}
      .product-image::after{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.02);opacity:0;transition:opacity 0.5s ease}
      .product-card:hover .product-image::after{opacity:1}
      
      /* Product info section - optimized */
      .product-info{position:relative;bottom:0;left:0;width:100%;padding:18px 18px 60px;background:white;color:#333;z-index:1;overflow:visible;border-top:1px solid rgba(240,240,240,0.8);transition:all 0.3s ease}
      .product-card:hover .product-info{background:linear-gradient(to bottom,#fff,#f9f9f9)}
      .product-title{font-size:15px;font-weight:500;margin-bottom:6px;color:#333;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;letter-spacing:0.01em}
      .price-container{display:flex;align-items:baseline;margin-top:6px;flex-wrap:wrap}
      .current-price{font-weight:600;color:{{ block.settings.badge_bg_color }};font-size:16px;margin-right:10px}
      .original-price{text-decoration:line-through;color:#999;font-size:13px;font-weight:400}
      .product-bio{font-size:13px;color:#777;margin:8px 0 6px;line-height:1.4;max-height:36px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical}
      
      /* Remove Tinder-style action buttons */
      
      /* Badges and indicators - optimized */
      .savings-badge{position:absolute;top:12px;right:12px;z-index:10;background-color:{{ block.settings.badge_bg_color }};color:white;padding:5px 12px;font-size:11px;font-weight:500;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.1);letter-spacing:0.5px;text-transform:uppercase}
      .photo-indicator{position:absolute;top:12px;left:12px;z-index:10;background-color:rgba(255,255,255,0.9);color:#333;padding:5px 12px;font-size:10px;font-weight:600;border-radius:4px;letter-spacing:0.5px;text-transform:uppercase;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
      @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
      
      /* Button styles - optimized */
      .add-to-cart{position:relative;padding:8px 12px;color:white;background-color:{{ block.settings.button_bg_color }};border:none;border-radius:4px;cursor:pointer;font-weight:500;font-size:12px;transition:all 0.3s ease;z-index:3;text-transform:uppercase;letter-spacing:0.5px;margin:8px 0 10px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
      .add-to-cart:hover{background-color:{{ block.settings.badge_bg_color }};box-shadow:0 3px 10px rgba(0,0,0,0.1)}
      .alpha-dog-carousel .product-card::before,.alpha-dog-carousel .product-card::after,.alpha-dog-carousel .add-to-cart::before,.alpha-dog-product-card::before,.alpha-dog-product-card::after,.alpha-dog-product-card .add-to-cart::before{content:none !important;display:none !important}
      .alpha-dog-carousel .add-to-cart,.alpha-dog-product-card .add-to-cart{margin:0 !important;width:auto !important;text-align:center !important}
      .alpha-dog-product-card{position:relative !important;overflow:hidden !important}
      .alpha-dog-product-card .add-to-cart{position:absolute !important;bottom:10px !important;left:10px !important;color:{{ block.settings.button_text_color }} !important;background-color:{{ block.settings.button_bg_color }} !important;text-decoration:none !important}
      
      /* Make sure there's no "Shop now" text before the button */
      .alpha-dog-product-card .add-to-cart::before,
      .alpha-dog-product-card .add-to-cart::after {
        content: none !important;
        display: none !important;
      }
      
      /* Hide shop-now elements */
      .alpha-dog-product-card [class*="shop-now"],.alpha-dog-product-card [class*="shopnow"],.alpha-dog-product-card .shop-now-text,.alpha-dog-product-card .shop-text,.alpha-dog-product-card .product-shop-now{display:none !important}
      
      /* Button active state */
      .add-to-cart:active{transform:translateY(0);box-shadow:0 2px 4px rgba(0,0,0,0.1)}
      
      /* Enhanced carousel & container - optimized */
      .alpha-dog-carousel{margin:40px auto;padding:10px 0 30px;position:relative;-webkit-overflow-scrolling:touch;width:100%;max-width:1200px;box-sizing:border-box}
      .products-container{width:100%;max-width:1200px;position:relative;margin:0 auto;display:flex;flex-direction:column;align-items:center}
      
      /* Mobile slider - optimized */
      .products-scroll{width:100%;overflow-x:auto;overflow-y:hidden;white-space:nowrap;scrollbar-width:none;-ms-overflow-style:none;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding:10px 0 25px;position:relative}
      .products-scroll::-webkit-scrollbar{display:none}
      .scroll-indicators{display:none;text-align:center;margin-top:15px}
      .scroll-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background-color:#ddd;margin:0 4px;transition:background-color 0.3s ease}
      .scroll-dot.active{background-color:{{ block.settings.badge_bg_color }}}
      .swipe-instruction{display:none;text-align:center;font-size:12px;color:#888;margin-top:10px;padding:5px}
      .product-slide{display:inline-block;vertical-align:top;white-space:normal;height:auto;width:280px;padding:4px;margin-right:10px;scroll-snap-align:start;position:relative}
      
      /* Desktop layout */
      @media (min-width:1024px){.alpha-dog-carousel .carousel-container{padding:0 20px}}
      
      /* Slider controls - optimized */
      .slider-controls{display:none;position:absolute;top:50%;width:100%;transform:translateY(-50%);z-index:5;pointer-events:none}
      .slider-control{position:absolute;width:40px;height:40px;background:rgba(255,255,255,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.1);pointer-events:auto}
      .slider-prev{left:10px}
      .slider-next{right:10px}
      
      /* Desktop grid layout - precisely centered with square product images and uniform cards */
      @media (min-width:1024px){
        .alpha-dog-carousel{overflow:visible;margin:40px auto;width:100%;max-width:1200px;left:0;right:0;position:relative}
        .carousel-container{width:100%;max-width:1200px;margin:0 auto;padding:0;left:0;right:0;position:relative}
        .products-container{max-width:1200px;width:100%;margin:0 auto;padding:0;left:0;right:0;position:relative}
        .products-scroll{display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(2,400px);grid-gap:20px;white-space:normal;overflow:visible;padding:0;width:100%;margin:0 auto;left:0;right:0;position:relative}
        .product-slide{width:100%;margin:0;display:block;padding:0;height:400px;aspect-ratio:auto}
        /* Force 8 cards to be visible, hide any beyond that */
        .product-slide:nth-child(-n+8){display:block !important}
        .product-slide:nth-child(n+9){display:none !important}
        /* Ensure all cards are exactly the same size */
        .alpha-dog-product-card,.product-card{height:400px !important;width:100% !important;min-height:400px !important;max-height:400px !important}
        .product-image-container{height:260px !important;min-height:260px !important;max-height:260px !important;width:260px !important;min-width:260px !important;max-width:260px !important;margin:0 auto !important}
      }
      
      @media (hover: hover) {
        .product-slide:hover .product-card {
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }
      }
      
      /* Add slight padding to carousel container */
      .carousel-container {
        padding: 0 5px;
      }
      
      /* Responsive styles - compressed */
      @media (min-width:1024px){
        .products-container{max-width:1200px;margin:0 auto}
        .products-scroll{overflow:visible}
        .slider-controls,.scroll-indicators,.swipe-instruction{display:none !important}
      }
      @media (min-width:768px) and (max-width:1023px){
        .products-scroll{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;white-space:normal;overflow:visible}
        .product-slide{width:100%;margin-right:0}
        .product-card{min-height:340px}
        .product-image{height:200px}
        .slider-controls,.scroll-indicators,.swipe-instruction{display:none !important}
      }
      @media (max-width:767px){
        .slider-controls,.scroll-indicators,.swipe-instruction{display:block}
        .product-slide{width:240px}
        .product-card{min-height:300px}
        .product-image{height:160px}
      }
      @media (max-width:480px){
        .alpha-dog-carousel{padding:5px}
        .product-slide{padding:4px;width:180px;margin-right:8px}
        .product-card{min-height:280px;border-radius:6px}
        .product-image-container{height:160px !important}
        .product-info{padding:8px}
        .product-title{font-size:12px;-webkit-line-clamp:1;margin-bottom:2px}
        .current-price{font-size:11px;margin-right:4px}
        .original-price{font-size:10px}
        .product-bio{font-size:10px;margin:4px 0}
        .photo-indicator,.savings-badge{font-size:9px;padding:2px 4px}
        .slider-control{width:30px;height:30px}
      }
      
      /* Minimal custom scrollbar */
      .custom-scrollbar::-webkit-scrollbar{width:8px;height:8px}
      .custom-scrollbar::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
      .custom-scrollbar::-webkit-scrollbar-thumb{background:#ccc;border-radius:10px}
      
      /* Debug styling - optimized */
      .debug-info{margin-top:20px;padding:15px;background-color:#f5f5f5;border:1px solid #ddd;border-radius:4px;font-size:12px;display:none}
      {% if block.settings.show_debug %}.debug-info{display:block}{% endif %}
    </style>

    <div class="carousel-header">
      <h2>{{ block.settings.heading_text }}</h2>
      <p>{{ block.settings.subtitle_text }}</p>
    </div>

    <!-- Enhanced Carousel with Mobile Slider and Desktop Grid -->
    <div class="products-container" style="position: relative; left: 0; right: 0; margin: 0 auto; max-width: 1200px; width: 100%;">
      <!-- Mobile Slider Controls -->
      <div class="slider-controls">
        <div class="slider-control slider-prev" onclick="slideCarousel('prev')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 6L9 12L15 18" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="slider-control slider-next" onclick="slideCarousel('next')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 6L15 12L9 18" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      
      <!-- Swipe Instruction for Mobile -->
      <div class="swipe-instruction">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 5px;">
          <path d="M14 6L18 10M18 10L14 14M18 10H6" stroke="#888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Swipe to see more products
      </div>
      
      <!-- Products Scroll Container -->
      <div class="products-scroll" id="products-scroll">
        {% assign custom_tag = block.settings.product_tag | default: 'DailyDiscount_每日優惠' %}
        {% assign desktop_limit = 8 %} {% comment %}Always show exactly 8 products on desktop{% endcomment %}
        {% assign counter = 0 %}
        {% assign total_products = 0 %}
        {% assign discounted_products = 0 %}
        
        {% comment %} 
          Approach 1: Try to use a collection with the tag name if it exists 
        {% endcomment %}
        {% assign tag_handle = custom_tag | handleize %}
        {% if collections[tag_handle] != blank and collections[tag_handle].products.size > 0 %}
          {% assign products_to_check = collections[tag_handle].products %}
        {% else %}
          {% comment %} 
            Approach 2: Use all products and check tags manually 
          {% endcomment %}
          {% assign products_to_check = collections.all.products %}
        {% endif %}
        
        {% assign total_products = products_to_check.size %}
        
        {% comment %} Display all products for comparison in debug mode {% endcomment %}
        {% if block.settings.show_debug %}
          <div class="debug-info">
            <p><strong>Using all products for display (debug mode)</strong></p>
          </div>
        {% endif %}
        
        {% comment %} Ensure we get exactly 8 products for desktop display {% endcomment %}
        
        {% for product in products_to_check %}
          {% assign should_display = false %}
          
          {% comment %} Check if product has the required tag {% endcomment %}
          {% if block.settings.show_all_products %}
            {% assign should_display = true %}
          {% else %}
            {% for tag in product.tags %}
              {% if tag == custom_tag %}
                {% assign should_display = true %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% if should_display or block.settings.show_all_products %}
            {% if counter < desktop_limit %}
              {% assign current_variant = product.selected_or_first_available_variant %}
              {% if current_variant.compare_at_price > current_variant.price or block.settings.show_non_discounted or counter < 8 %}
                {% assign discounted_products = discounted_products | plus: 1 %}
                {% assign savings_amount = current_variant.compare_at_price | minus: current_variant.price %}
                {% assign savings_percentage = savings_amount | times: 100 | divided_by: current_variant.compare_at_price | round | at_least: 1 %}
                
                <div class="product-slide">
                  <div class="product-card" style="position: relative; background: white; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); overflow: hidden; height: 100%; display: flex; flex-direction: column;">
                    <!-- Product Image Section -->
                    <a href="{{ product.url }}" style="text-decoration: none; display: block;">
                      <div class="product-image-container" style="height: 260px; width: 260px; padding: 0; object-fit: contain; display: flex; align-items: center; justify-content: center; margin: 0 auto; aspect-ratio: 1/1;">
                        {% if product.featured_image %}
                          <img src="{{ product.featured_image | image_url: width: 400 }}" 
                               alt="{{ product.title }}" 
                               style="width: 100%; height: 100%; object-fit: contain; max-width: 100%; max-height: {{ block.settings.image_height }}px;" 
                               loading="lazy"
                               width="400" 
                               height="{{ block.settings.image_height }}">
                        {% else %}
                          <img src="{{ 'placeholder-image.jpg' | asset_url }}" 
                               alt="{{ product.title }}" 
                               style="width: 100%; height: 100%; object-fit: cover; max-width: 100%;" 
                               loading="lazy"
                               width="400" 
                               height="{{ block.settings.image_height }}">
                        {% endif %}
                        
                        <!-- Sale badge overlaid directly on image -->
                        <div style="position: absolute; top: 8px; left: 8px; background-color: rgba(0,0,0,0.7); color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; font-weight: 500; text-transform: uppercase; z-index: 5;">SALE</div>
                        
                        {% if current_variant.compare_at_price > current_variant.price %}
                          <div style="position: absolute; top: 8px; right: 8px; background-color: {{ block.settings.badge_bg_color }}; color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; font-weight: 500; z-index: 5;">{{ savings_percentage }}% OFF</div>
                        {% endif %}
                      </div>
                      
                      <!-- Product Info Section -->
                      <div style="padding: 12px 12px 60px; border-top: 1px solid #f0f0f0;">
                        <div style="font-size: 15px; font-weight: 500; margin-bottom: 6px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ product.title }}</div>
                        
                        {% if current_variant.title != 'Default Title' %}
                        <div style="font-size: 12px; color: #666; margin-bottom: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                          Variant: {{ current_variant.title }}
                        </div>
                        {% endif %}
                        
                        <div style="display: flex; align-items: baseline; margin-top: 4px;">
                          <div style="font-weight: 600; color: {{ block.settings.badge_bg_color }}; font-size: 16px; margin-right: 8px;">{{ current_variant.price | money }}</div>
                          {% if current_variant.compare_at_price > current_variant.price %}
                            <div style="text-decoration: line-through; color: #999; font-size: 13px;">{{ current_variant.compare_at_price | money }}</div>
                          {% endif %}
                        </div>
                      </div>
                    </a>
                    
                    <!-- Add to Cart Button - Always Visible -->
                    <div style="position: absolute; bottom: 15px; left: 15px; width: calc(100% - 30px); z-index: 100;">
                      <button 
                          onclick="addToCart('{{ current_variant.id }}')" 
                          {% unless current_variant.available %}disabled{% endunless %}
                          style="width: 100%; 
                                 padding: 10px 0; 
                                 background-color: {{ block.settings.button_bg_color }}; 
                                 color: white; 
                                 border: none; 
                                 border-radius: 4px; 
                                 font-weight: 500; 
                                 font-size: 12px; 
                                 text-transform: uppercase; 
                                 cursor: pointer;
                                 display: block !important;
                                 opacity: 1 !important;
                                 visibility: visible !important;">
                        {% if current_variant.available %}
                          ADD TO CART
                        {% else %}
                          SOLD OUT
                        {% endif %}
                      </button>
                    </div>
                  </div>
                </div>
                {% assign counter = counter | plus: 1 %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
        
        {% comment %} Add placeholders if fewer than 8 products are found {% endcomment %}
        {% if counter < desktop_limit %}
          {% assign placeholders_needed = desktop_limit | minus: counter %}
          {% for i in (1..placeholders_needed) %}
            <div class="product-slide">
              <div class="product-card" style="position: relative; background: white; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); overflow: hidden; height: 100%; display: flex; flex-direction: column;">
                <!-- Product Image Section -->
                <div style="height: 260px; width: 260px; padding: 0; display: flex; align-items: center; justify-content: center; background-color: {{ block.settings.image_bg_color }}; margin: 0 auto; aspect-ratio: 1/1;">
                  <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 18px;">
                    No Image
                  </div>
                </div>
                
                <!-- Product Info Section -->
                <div style="padding: 12px 12px 60px; border-top: 1px solid #f0f0f0;">
                  <div style="font-size: 15px; font-weight: 500; margin-bottom: 6px; color: #333;">Coming Soon</div>
                  <div style="display: flex; align-items: baseline; margin-top: 4px;">
                    <div style="font-weight: 600; color: {{ block.settings.badge_bg_color }}; font-size: 16px;">Stay Tuned</div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
      
      <!-- Scroll Indicators for Mobile -->
      <div class="scroll-indicators" id="scroll-indicators">
        <!-- Dots will be dynamically generated by JavaScript -->
      </div>
    </div>
    
    {% if counter == 0 and placeholders_needed != desktop_limit %}
      <p style="text-align: center; margin: 50px 0; color: #666;">
        No discounted products available with the selected tag.
      </p>
    {% endif %}
    
    {% if block.settings.show_debug %}
    <div class="debug-info custom-scrollbar">
      <h4>Debug Information</h4>
      <p>Looking for tag: "{{ custom_tag }}"</p>
      <p>Tag handle: "{{ tag_handle }}"</p>
      <p>Collection with tag exists: {% if collections[tag_handle] != blank %}Yes{% else %}No{% endif %}</p>
      <p>Total products checked: {{ total_products }}</p>
      <p>Products with discounts: {{ discounted_products }}</p>
      <p>Products displayed: {{ counter }}</p>
      
      <h4>All Available Tags</h4>
      <div style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto;" class="custom-scrollbar">
        {% assign all_tags = collections.all.products | map: 'tags' | join: ',' | split: ',' | uniq | sort %}
        {% for tag in all_tags %}
          <div style="background: #eee; padding: 5px 10px; border-radius: 4px; margin-bottom: 4px;">{{ tag }}</div>
        {% endfor %}
      </div>

      <h4>Search Options</h4>
      <p>Try using the tags exactly as shown above. You can also try the following approaches:</p>
      <ol>
        <li>Change the tag to use an exact tag from the list above</li>
        <li>Create a collection with the same name as your tag</li>
        <li>Check "Show All Discounted Products" to see all available discounted products</li>
      </ol>
      
      <h4>Test Products</h4>
      <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 10px;" class="custom-scrollbar">
        <p><strong>First 10 products and their tags:</strong></p>
        {% for product in collections.all.products limit: 10 %}
          <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
            <strong>{{ product.title }}</strong><br>
            Tags: 
            {% if product.tags.size > 0 %}
              {% for tag in product.tags %}
                <span style="background: #f5f5f5; padding: 2px 6px; margin-right: 4px; border-radius: 3px; font-size: 11px;">{{ tag }}</span>
              {% endfor %}
            {% else %}
              <em>No tags</em>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
  
  <!-- Simple "Add to cart" functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ps = document.getElementById('products-scroll');
      const si = document.getElementById('scroll-indicators');
      if (!ps || !si) return;
      const slides = ps.querySelectorAll('.product-slide');
      const sc = slides.length;
      if (sc > 0 && window.innerWidth < 768) initMobileSlider(ps, si, slides, sc);
      window.addEventListener('resize', function() {
        if (window.innerWidth < 768) {if (si.children.length === 0 && sc > 0) initMobileSlider(ps, si, slides, sc);
        } else {si.innerHTML = '';}
      });
    });
    
    function initMobileSlider(ps, si, slides, sc) {
      si.innerHTML = '';
      for (let i = 0; i < sc; i++) {
        const dot = document.createElement('span');
        dot.className = 'scroll-dot';
        if (i === 0) dot.classList.add('active');
        dot.dataset.index = i;
        dot.addEventListener('click', function() {
          const index = parseInt(this.dataset.index);
          if (slides[index]) slides[index].scrollIntoView({behavior:'smooth',block:'nearest',inline:'start'});
        });
        si.appendChild(dot);
      }
      
      let st;
      ps.addEventListener('scroll', function() {
        if (st) clearTimeout(st);
        st = setTimeout(function() {updateActiveDot(ps, slides);}, 50);
      });
      
      updateActiveDot(ps, slides);
      
      let tsx = 0, tex = 0;
      ps.addEventListener('touchstart', function(e) {tsx = e.touches[0].clientX;}, false);
      ps.addEventListener('touchend', function(e) {
        tex = e.changedTouches[0].clientX;
        if (tex < tsx - 50) slideCarousel('next');
        else if (tex > tsx + 50) slideCarousel('prev');
      }, false);
    }
    
    function updateActiveDot(ps, slides) {
      const dots = document.querySelectorAll('.scroll-dot');
      if (!dots.length) return;
      const sl = ps.scrollLeft;
      const cw = ps.clientWidth;
      let ai = 0, bv = 0;
      
      slides.forEach((slide, i) => {
        const slf = slide.offsetLeft - ps.offsetLeft;
        const sr = slf + slide.offsetWidth;
        const vl = Math.max(0, slf);
        const vr = Math.min(sr, sl + cw);
        const vw = Math.max(0, vr - vl);
        if (vw > bv) {bv = vw; ai = i;}
      });
      
      dots.forEach((dot, i) => {
        if (i === ai) dot.classList.add('active');
        else dot.classList.remove('active');
      });
    }
    
    function slideCarousel(d) {
      const ps = document.getElementById('products-scroll');
      if (!ps) return;
      const sw = ps.querySelector('.product-slide')?.offsetWidth || 240;
      ps.scrollBy({left: d === 'next' ? sw : -sw, behavior: 'smooth'});
    }
    
    function addToCart(vid) {
      const btn = event.target;
      const ot = btn.textContent;
      btn.textContent = 'ADDING...';
      btn.disabled = true;
      
      fetch('/cart/add.js', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
        body: JSON.stringify({id: vid, quantity: 1})
      })
      .then(r => r.json())
      .then(d => {
        btn.textContent = 'ADDED!';
        setTimeout(() => {btn.textContent = ot; btn.disabled = false;}, 2000);
        if (typeof window.refreshCart === 'function') window.refreshCart();
      })
      .catch(e => {
        console.error('Error adding to cart:', e);
        btn.textContent = 'ERROR';
        setTimeout(() => {btn.textContent = ot; btn.disabled = false;}, 2000);
      });
    }
    
    {% if block.settings.autoplay %}
    document.addEventListener('DOMContentLoaded', function() {
      const ps = document.getElementById('products-scroll');
      if (ps && window.innerWidth < 1024) {
        let ci = 0;
        const slides = ps.querySelectorAll('.product-slide');
        const sc = slides.length;
        const sp = {{ block.settings.autoplay_delay }};
        let at = null;
        
        function startAP() {
          if (at) return;
          at = setInterval(function() {
            ci = (ci + 1) % sc;
            const ts = slides[ci];
            if (ts) {
              ts.scrollIntoView({behavior:'smooth',block:'nearest',inline:'start'});
              const dots = document.querySelectorAll('.scroll-dot');
              dots.forEach((dot, i) => {
                if (i === ci) dot.classList.add('active');
                else dot.classList.remove('active');
              });
            }
          }, sp);
        }
        
        function pauseAP() {clearInterval(at); at = null;}
        
        ps.addEventListener('mouseenter', pauseAP);
        ps.addEventListener('touchstart', pauseAP);
        if (window.innerWidth < 768) ps.addEventListener('mouseleave', startAP);
        setTimeout(startAP, sp);
        
        window.addEventListener('resize', function() {
          if (window.innerWidth >= 1024) pauseAP();
          else if (!at && window.innerWidth < 768) startAP();
        });
      }
    });
    {% endif %}
  </script>
</div>

{% schema %}
{
  "name": "Product Carousel",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "product_tag",
      "label": "Product Tag",
      "default": "DailyDiscount_每日優惠"
    },
    {
      "type": "text",
      "id": "heading_text",
      "label": "Heading",
      "default": "Exclusive Deals & Offers"
    },
    {
      "type": "text",
      "id": "subtitle_text",
      "label": "Subtitle",
      "default": "Discover our curated selection of premium products"
    },
    {
      "type": "range",
      "id": "max_products",
      "min": 1,
      "max": 24,
      "step": 1,
      "label": "Max Products",
      "default": 12
    },
    {
      "type": "header",
      "content": "Design"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "subtitle_color",
      "label": "Subtitle Color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "card_bg_color",
      "label": "Card Background",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "card_height",
      "min": 280,
      "max": 500,
      "step": 10,
      "label": "Card Height",
      "default": 380
    },
    {
      "type": "range",
      "id": "image_height",
      "min": 150,
      "max": 350,
      "step": 10,
      "label": "Image Height",
      "default": 260
    },
    {
      "type": "select",
      "id": "card_shadow",
      "label": "Card Shadow",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "0 2px 5px rgba(0, 0, 0, 0.05)",
          "label": "Light"
        },
        {
          "value": "0 3px 10px rgba(0, 0, 0, 0.08)",
          "label": "Medium"
        },
        {
          "value": "0 5px 15px rgba(0, 0, 0, 0.12)",
          "label": "Bold"
        }
      ],
      "default": "0 3px 10px rgba(0, 0, 0, 0.08)"
    },
    {
      "type": "color",
      "id": "badge_bg_color",
      "label": "Sale Badge Color",
      "default": "#FF385C"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#ffffff"
    },
    {
      "type": "select",
      "id": "overlay_gradient_style",
      "label": "Overlay Style",
      "options": [
        {
          "value": "gradient",
          "label": "Gradient"
        },
        {
          "value": "solid",
          "label": "Solid"
        },
        {
          "value": "none",
          "label": "None"
        }
      ],
      "default": "gradient"
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "Overlay Color",
      "default": "rgba(0,0,0,0.7)"
    },
    {
      "type": "checkbox",
      "id": "badge_round",
      "label": "Rounded Badges",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_pagination",
      "label": "Show Pagination",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Show Navigation",
      "default": true
    }, 
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable Autoplay",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "loop",
      "label": "Infinite Loop",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_all_products",
      "label": "Show All Discounted",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "navigation_round",
      "label": "Round Navigation",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_delay",
      "min": 1000,
      "max": 9000,
      "step": 1000,
      "label": "Autoplay Delay",
      "default": 3000
    }
  ]
}
{% endschema %}