{% comment %}
  Premium Pet Products Carousel by Alpha Dog
  An elegant, high-end carousel display for your premium pet products
{% endcomment %}

<!-- No external CSS needed for simple scroll slider -->

<div id="alpha-dog-carousel" class="alpha-dog-carousel" style="margin: 40px auto; max-width: 1200px; width: 100%; left: 0; right: 0; position: relative; text-align: center;">
  <div class="carousel-container" style="max-width: 1200px; margin: 0 auto; width: 100%; left: 0; right: 0; position: relative;">
    <style>
      /* Main carousel container - exact centering */
      .alpha-dog-carousel{margin:40px auto;overflow:hidden;position:relative;padding:10px 0 30px;max-width:1200px;width:100%;left:0;right:0}
      
      /* Header styling - optimized */
      .carousel-header{text-align:center;margin-bottom:35px;position:relative;z-index:2}
      .carousel-header h2{color:{{ block.settings.heading_color }};font-size:28px;margin-bottom:12px;font-weight:600;letter-spacing:0.02em;position:relative;display:inline-block}
      .carousel-header h2::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:50px;height:2px;background-color:{{ block.settings.heading_color }}}
      .carousel-header p{color:{{ block.settings.subtitle_color }};font-size:15px;max-width:700px;margin:0 auto;line-height:1.5;font-weight:300}
      
      /* Product card design - adaptive height */
      .product-card,.alpha-dog-product-card{position:relative;width:280px !important;height:auto !important;min-height:0 !important;max-height:none !important;background-color:{{ block.settings.card_bg_color }};border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.06);overflow:hidden;transition:all 0.4s cubic-bezier(0.22,1,0.36,1);cursor:pointer;display:flex;flex-direction:column;border:1px solid rgba(240,240,240,0.8);margin:0 auto;box-sizing:border-box}
      
      /* Product image container - square format with proper image sizing */
      .product-image-container{width:280px !important;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;background-color:{{ block.settings.image_bg_color }};flex:0;margin:0 auto;border-radius:8px 8px 0 0;height:280px !important;min-height:280px !important;max-height:280px !important;aspect-ratio:1/1 !important;padding:10px}
      /* Badge styling with important flags to override theme styles - positioned within product image container only */
      .sale-badge{position:absolute !important;top:8px !important;left:8px !important;background-color:rgba(0,0,0,0.7) !important;color:white !important;padding:4px 8px !important;font-size:11px !important;border-radius:4px !important;font-weight:500 !important;text-transform:uppercase !important;z-index:5 !important;pointer-events:none}
      .discount-badge{position:absolute !important;top:8px !important;right:8px !important;background-color:{{ block.settings.badge_bg_color }} !important;color:white !important;padding:4px 8px !important;font-size:11px !important;border-radius:4px !important;font-weight:500 !important;z-index:5 !important;pointer-events:none}
      
      .product-card:hover,.alpha-dog-product-card:hover{transform:translateY(-6px);box-shadow:0 12px 24px rgba(0,0,0,0.08);border-color:rgba(220,220,220,0.8)}
      .product-card:active,.alpha-dog-product-card:active{transform:translateY(-2px);transition:all 0.2s}
      
      .product-image{width:280px;height:280px;position:relative;overflow:hidden;background-color:{{ block.settings.image_bg_color }};flex-shrink:0;display:flex;align-items:center;justify-content:center;padding:10px;transition:all 0.4s ease;aspect-ratio:1/1}
      .product-image img{width:auto;height:auto;max-width:100%;max-height:100%;object-fit:contain;display:block;transition:transform 0.7s cubic-bezier(0.22,1,0.36,1);margin:0 auto}
      .product-card:hover .product-image img{transform:scale(1.08)}
      .product-image::after{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.02);opacity:0;transition:opacity 0.5s ease}
      .product-card:hover .product-image::after{opacity:1}
      
      /* Product info section - optimized with reduced bottom padding and improved price display */
      .product-info{position:relative;bottom:0;left:0;width:100%;padding:18px 18px 18px;background:white;color:#333;z-index:1;overflow:visible;border-top:1px solid rgba(240,240,240,0.8);transition:all 0.3s ease}
      .product-card:hover .product-info{background:linear-gradient(to bottom,#fff,#f9f9f9)}
      .product-title{font-size:15px;font-weight:500;margin-bottom:6px;color:#333;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;letter-spacing:0.01em}
      .price-container{display:flex;align-items:baseline;margin-top:6px;flex-wrap:wrap;justify-content:space-between}
      .current-price{font-weight:600;color:{{ block.settings.badge_bg_color }};font-size:15px;margin-right:6px;letter-spacing:-0.01em}
      .original-price{text-decoration:line-through;color:#999;font-size:12px;font-weight:400}
      .product-bio{font-size:13px;color:#777;margin:8px 0 6px;line-height:1.4;max-height:36px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical}
      
      /* Remove Tinder-style action buttons */
      
      /* Badges and indicators - optimized */
      .savings-badge{position:absolute;top:12px;right:12px;z-index:10;background-color:{{ block.settings.badge_bg_color }};color:white;padding:5px 12px;font-size:11px;font-weight:500;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.1);letter-spacing:0.5px;text-transform:uppercase}
      .photo-indicator{position:absolute;top:12px;left:12px;z-index:10;background-color:rgba(255,255,255,0.9);color:#333;padding:5px 12px;font-size:10px;font-weight:600;border-radius:4px;letter-spacing:0.5px;text-transform:uppercase;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
      @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
      
      /* Button styles - smaller and optimized */
      .add-to-cart{position:relative;padding:4px 8px;color:{{ block.settings.button_text_color | default: 'white' }};background-color:{{ block.settings.button_bg_color }};border:none;border-radius:4px;cursor:pointer;font-weight:500;font-size:10px;transition:all 0.3s ease;z-index:3;letter-spacing:0px;margin:8px 0 10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);min-width:60px;max-width:80px;text-align:center}
      .add-to-cart:hover{background-color:{{ block.settings.button_hover_color | default: block.settings.badge_bg_color }};box-shadow:0 3px 10px rgba(0,0,0,0.1)}
      .alpha-dog-carousel .product-card::before,.alpha-dog-carousel .product-card::after,.alpha-dog-carousel .add-to-cart::before,.alpha-dog-product-card::before,.alpha-dog-product-card::after,.alpha-dog-product-card .add-to-cart::before{content:none !important;display:none !important}
      .alpha-dog-carousel .add-to-cart,.alpha-dog-product-card .add-to-cart{margin:0 !important;text-align:center !important}
      .alpha-dog-product-card{position:relative !important;overflow:hidden !important}
      .alpha-dog-product-card .add-to-cart{position:absolute !important;bottom:10px !important;left:10px !important;color:{{ block.settings.button_text_color }} !important;background-color:{{ block.settings.button_bg_color }} !important;text-decoration:none !important}
      
      /* Make sure there's no "Shop now" text before the button */
      .alpha-dog-product-card .add-to-cart::before,
      .alpha-dog-product-card .add-to-cart::after {
        content: none !important;
        display: none !important;
      }
      
      /* Hide shop-now elements */
      .alpha-dog-product-card [class*="shop-now"],.alpha-dog-product-card [class*="shopnow"],.alpha-dog-product-card .shop-now-text,.alpha-dog-product-card .shop-text,.alpha-dog-product-card .product-shop-now{display:none !important}
      
      /* Button active state */
      .add-to-cart:active{transform:translateY(0);box-shadow:0 2px 4px rgba(0,0,0,0.1)}
      
      /* Enhanced carousel & container - optimized */
      .alpha-dog-carousel{margin:40px auto;padding:10px 0 30px;position:relative;-webkit-overflow-scrolling:touch;width:100%;max-width:1200px;box-sizing:border-box}
      .products-container{width:100%;max-width:1200px;position:relative;margin:0 auto;display:flex;flex-direction:column;align-items:center;justify-content:center}
      
      /* Mobile slider - optimized */
      .products-scroll{width:100%;overflow-x:auto;overflow-y:hidden;white-space:nowrap;scrollbar-width:none;-ms-overflow-style:none;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding:10px 0 25px;position:relative}
      .products-scroll::-webkit-scrollbar{display:none}
      
      /* Placeholder styling */
      .placeholder-slide .product-card {
        background: {{ block.settings.placeholder_bg_color | default: '#f9f9f9' }};
        transition: all 0.3s ease;
      }
      .placeholder-slide:hover .product-card {
        transform: translateY(-6px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.08);
      }
      .scroll-indicators{display:none;text-align:center;margin-top:15px}
      .scroll-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background-color:#ddd;margin:0 4px;transition:background-color 0.3s ease}
      .scroll-dot.active{background-color:{{ block.settings.badge_bg_color }}}
      /* Removed swipe instruction class */
      .product-slide{display:inline-block;vertical-align:top;white-space:normal;height:auto;width:280px;padding:4px;margin-right:10px;scroll-snap-align:start;position:relative}
      
      /* Desktop layout */
      @media (min-width:1024px){.alpha-dog-carousel .carousel-container{padding:0 20px}}
      
      /* Slider controls - optimized */
      .slider-controls{display:none;position:absolute;top:50%;width:100%;transform:translateY(-50%);z-index:5;pointer-events:none}
      .slider-control{position:absolute;width:40px;height:40px;background:rgba(255,255,255,0.9);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.1);pointer-events:auto}
      .slider-prev{left:10px}
      .slider-next{right:10px}
      
      /* Desktop grid layout - precisely centered with square product images and uniform cards */
      @media (min-width:1024px){
        .alpha-dog-carousel{overflow:visible;margin:40px auto;width:100%;max-width:1200px;left:0;right:0;position:relative}
        .carousel-container{width:100%;max-width:1200px;margin:0 auto;padding:0;left:0;right:0;position:relative}
        .products-container{max-width:1200px;width:100%;margin:0 auto;padding:0;left:0;right:0;position:relative}
        .products-scroll{display:grid;grid-template-columns:repeat(4,280px);grid-template-rows:repeat(2,400px);grid-gap:20px;white-space:normal;overflow:visible;padding:0;width:auto;margin:0 auto;left:0;right:0;position:relative;justify-content:center}
        .product-slide{width:280px;margin:0;display:block;padding:0;height:400px;aspect-ratio:auto}
        /* Force 8 cards to be visible, hide any beyond that */
        .product-slide:nth-child(-n+8){display:block !important}
        .product-slide:nth-child(n+9){display:none !important}
        /* Set all cards to fixed height to ensure uniformity */
        .alpha-dog-product-card,.product-card,.placeholder-slide .product-card{height:400px !important;width:280px !important;margin:0 auto !important;min-height:400px !important;max-height:400px !important}
        .product-image-container{height:280px !important;min-height:280px !important;max-height:280px !important;width:280px !important;min-width:280px !important;max-width:280px !important;margin:0 auto !important}
      }
      
      @media (hover: hover) {
        .product-slide:hover .product-card {
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }
      }
      
      /* Add slight padding to carousel container */
      .carousel-container {
        padding: 0 5px;
      }
      
      /* Responsive styles - compressed */
      @media (min-width:1024px){
        .products-container{max-width:1200px;margin:0 auto}
        .products-scroll{overflow:visible}
        .slider-controls,.scroll-indicators{display:none !important}
      }
      @media (min-width:768px) and (max-width:1023px){
        .products-scroll{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;white-space:normal;overflow:visible}
        .product-slide{width:100%;margin-right:0}
        /* Fixed height for all cards on tablet */
        .product-card, .placeholder-slide .product-card{min-height:340px !important;height:340px !important;max-height:340px !important}
        .product-image{height:200px}
        .slider-controls,.scroll-indicators{display:none !important}
      }
      @media (max-width:767px){
        .slider-controls,.scroll-indicators{display:block}
        .product-slide{width:240px}
        /* Fixed height for all cards on mobile */
        .product-card, .placeholder-slide .product-card{height:300px !important;min-height:300px !important;max-height:300px !important}
        .product-image{height:160px}
      }
      @media (max-width:480px){
        .alpha-dog-carousel{padding:5px}
        .product-slide{padding:4px;width:180px;margin-right:8px}
        /* Set fixed height for all product cards */
        .product-card, .placeholder-slide .product-card{min-height:280px !important;max-height:280px !important;height:280px !important;border-radius:6px;width:180px !important;overflow:hidden}
        /* Set fixed height for image container */
        .product-card > a > div:first-child, .placeholder-slide .product-card > a > div:first-child{height:180px !important;min-height:180px !important;max-height:180px !important;width:180px !important;min-width:180px !important;max-width:180px !important}
        .product-info{padding:8px;max-height:100px;overflow:hidden}
        .product-title{font-size:12px;-webkit-line-clamp:1;margin-bottom:2px}
        .current-price{font-size:11px;margin-right:4px;letter-spacing:-0.02em}
        .original-price{font-size:10px}
        .product-bio{font-size:10px;margin:4px 0}
        .photo-indicator,.savings-badge{font-size:9px;padding:2px 4px}
        .slider-control{width:30px;height:30px}
        /* Make badges smaller on mobile and ensure they're contained within the image area */
        .product-card div[style*="position: absolute"][style*="background-color"]{
          font-size:9px !important;
          padding:2px 4px !important;
          z-index:5 !important;
          pointer-events:none !important;
          top:8px !important;
        }
        /* Shorter add to cart button for mobile */
        .add-to-cart, button[onclick*="addToCart"], [style*="加入優惠"], [style*="{{ block.settings.button_text }}"] {
          padding:4px 6px !important;
          min-width:50px !important;
          max-width:70px !important;
          font-size:9px !important;
          text-align:center !important;
        }
        
        /* Ensure placeholder images maintain square aspect ratio on mobile */
        .placeholder-slide .product-card div[style*="position: relative; width: 100%; height: 100%; overflow: hidden;"] {
          aspect-ratio: 1/1 !important;
          width: 100% !important;
          height: 0 !important;
          padding-bottom: 100% !important;
        }
        
        /* Ensure the bottom margin for price info is maintained on mobile */
        .product-info > div[style*="margin-bottom: 42px"] {
          margin-bottom: 36px !important;
        }
      }
      
      /* Minimal custom scrollbar */
      .custom-scrollbar::-webkit-scrollbar{width:8px;height:8px}
      .custom-scrollbar::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
      .custom-scrollbar::-webkit-scrollbar-thumb{background:#ccc;border-radius:10px}
      
      /* Debug styling - optimized */
      .debug-info{margin-top:20px;padding:15px;background-color:#f5f5f5;border:1px solid #ddd;border-radius:4px;font-size:12px;display:none}
      {% if block.settings.show_debug %}.debug-info{display:block}{% endif %}
    </style>

    <!-- Carousel header - Will appear under the "每日優惠" section -->
    <div class="carousel-header">
      <h2>{{ block.settings.heading_text }}</h2>
      <p>{{ block.settings.subtitle_text }}</p>
    </div>

    <!-- Enhanced Carousel with Mobile Slider and Desktop Grid -->
    <div class="products-container" style="position: relative; left: 0; right: 0; margin: 0 auto; max-width: 1200px; width: 100%; display: flex; flex-direction: column; align-items: center;">
      <!-- Mobile Slider Controls -->
      <div class="slider-controls">
        <div class="slider-control slider-prev" onclick="slideCarousel('prev')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 6L9 12L15 18" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="slider-control slider-next" onclick="slideCarousel('next')">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 6L15 12L9 18" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      
      <!-- Removed Swipe Instruction for cleaner UI -->
      
      <!-- Products Scroll Container -->
      <div class="products-scroll" id="products-scroll">
        {% assign custom_tag = block.settings.product_tag | default: 'DailyDiscount_每日優惠' %}
        {% assign desktop_limit = 8 %} {% comment %}Always show exactly 8 products on desktop{% endcomment %}
        {% assign counter = 0 %}
        {% assign total_products = 0 %}
        {% assign discounted_products = 0 %}
        
        {% comment %} 
          Approach 1: Try to use a collection with the tag name if it exists 
        {% endcomment %}
        {% assign tag_handle = custom_tag | handleize %}
        {% if collections[tag_handle] != blank and collections[tag_handle].products.size > 0 %}
          {% assign products_to_check = collections[tag_handle].products %}
        {% else %}
          {% comment %} 
            Approach 2: Use all products and check tags manually 
          {% endcomment %}
          {% assign products_to_check = collections.all.products %}
        {% endif %}
        
        {% assign total_products = products_to_check.size %}
        
        {% comment %} Display all products for comparison in debug mode {% endcomment %}
        {% if block.settings.show_debug %}
          <div class="debug-info">
            <p><strong>Using all products for display (debug mode)</strong></p>
          </div>
        {% endif %}
        
        {% comment %} Ensure we get exactly 8 products for desktop display {% endcomment %}
        
        {% for product in products_to_check %}
          {% assign should_display = false %}
          
          {% comment %} Check if product has the required tag {% endcomment %}
          {% if block.settings.show_all_products %}
            {% assign should_display = true %}
          {% else %}
            {% for tag in product.tags %}
              {% if tag == custom_tag %}
                {% assign should_display = true %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% if should_display or block.settings.show_all_products %}
            {% if counter < desktop_limit %}
              {% assign found_discounted_variant = false %}
              {% assign current_variant = product.selected_or_first_available_variant %}
              
              {% comment %} Look for the specific variant that's on sale {% endcomment %}
              {% for variant in product.variants %}
                {% if variant.compare_at_price > variant.price %}
                  {% assign current_variant = variant %}
                  {% assign found_discounted_variant = true %}
                  {% break %}
                {% endif %}
              {% endfor %}
              
              {% if current_variant.compare_at_price > current_variant.price or block.settings.show_non_discounted or counter < 8 %}
                {% assign discounted_products = discounted_products | plus: 1 %}
                {% assign savings_amount = current_variant.compare_at_price | minus: current_variant.price %}
                {% assign savings_percentage = savings_amount | times: 100 | divided_by: current_variant.compare_at_price | round | at_least: 1 %}
                
                <div class="product-slide">
                  <div class="product-card" style="position: relative; background: white; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); overflow: hidden; height: auto; display: flex; flex-direction: column;">
                    <!-- Product Image Section with Badges Directly Overlaid -->
                    <a href="{{ product.url }}" style="text-decoration: none; display: block; position: relative;">
                      <div style="position: relative; height: 280px; width: 280px; padding: 0; display: flex; align-items: center; justify-content: center; background-color: {{ block.settings.image_bg_color }}; margin: 0 auto; aspect-ratio: 1/1;">
                        {% if product.featured_image %}
                          <img src="{{ product.featured_image | image_url: width: 400 }}" 
                               alt="{{ product.title }}" 
                               style="width: auto; height: auto; max-width: 100%; max-height: 100%; object-fit: contain; margin: 0 auto;" 
                               loading="lazy"
                               width="400" 
                               height="{{ block.settings.image_height }}">
                        {% else %}
                          <img src="{{ 'placeholder-image.jpg' | asset_url }}" 
                               alt="{{ product.title }}" 
                               style="width: 100%; height: 100%; object-fit: cover; max-width: 100%;" 
                               loading="lazy"
                               width="400" 
                               height="{{ block.settings.image_height }}">
                        {% endif %}
                      </div>
                      
                      <!-- Sale badge positioned within the image container only -->
                      <div style="position: absolute; top: 8px; left: 8px; background-color: rgba(0,0,0,0.7); color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; font-weight: 500; text-transform: uppercase; z-index: 5; pointer-events: none;">SALE</div>
                      
                      {% if current_variant.compare_at_price > current_variant.price %}
                        <div style="position: absolute; top: 8px; right: 8px; background-color: {{ block.settings.badge_bg_color }}; color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; font-weight: 500; z-index: 5; pointer-events: none;">{{ savings_percentage }}% OFF</div>
                      {% endif %}
                      
                      <!-- Product Info Section -->
                      <div style="padding: 12px 12px 12px; border-top: 1px solid #f0f0f0;">
                        <div style="font-size: 15px; font-weight: 500; margin-bottom: 6px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ product.title }}</div>
                        
                        {% if current_variant.title != 'Default Title' %}
                        <div style="font-size: 12px; color: #666; margin-bottom: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                          Variant: {{ current_variant.title }}
                        </div>
                        {% endif %}
                        
                        <!-- Price and Button Side by Side - improved spacing for 3-digit prices -->
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 8px;">
                          <div style="display: flex; align-items: baseline; flex-wrap: wrap; max-width: 60%;">
                            <div style="font-weight: 600; color: {{ block.settings.badge_bg_color }}; font-size: 15px; margin-right: 6px; letter-spacing: -0.01em;">{{ current_variant.price | money }}</div>
                            {% if current_variant.compare_at_price > current_variant.price %}
                              <div style="text-decoration: line-through; color: #999; font-size: 12px;">{{ current_variant.compare_at_price | money }}</div>
                            {% endif %}
                          </div>
                          
                          <!-- Add to Cart Button Inline - smaller -->
                          <button 
                              onclick="addToCart('{{ current_variant.id }}'); event.preventDefault();" 
                              {% unless current_variant.available %}disabled{% endunless %}
                              style="padding: 4px 8px; 
                                     background-color: {{ block.settings.button_bg_color }}; 
                                     color: {{ block.settings.button_text_color | default: 'white' }}; 
                                     border: none; 
                                     border-radius: 4px; 
                                     font-weight: 500; 
                                     font-size: 10px; 
                                     cursor: pointer;
                                     display: block !important;
                                     opacity: 1 !important;
                                     visibility: visible !important;
                                     white-space: nowrap;
                                     min-width: 60px;
                                     max-width: 80px;">
                            {% if current_variant.available %}
                              {{ block.settings.button_text | default: '加入優惠' }}
                            {% else %}
                              {{ block.settings.sold_out_text | default: 'SOLD OUT' }}
                            {% endif %}
                          </button>
                        </div>
                      </div>
                    </a>
                  </div>
                </div>
                {% assign counter = counter | plus: 1 %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
        
        {% comment %} Add placeholders if fewer than 8 products are found {% endcomment %}
        {% if counter < desktop_limit and block.settings.show_placeholders %}
          {% assign placeholders_needed = desktop_limit | minus: counter %}
          {% for i in (1..placeholders_needed) %}
            <div class="product-slide placeholder-slide">
              <div class="product-card" style="position: relative; background: white; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); overflow: hidden; height: auto; display: flex; flex-direction: column;">
                <!-- Simple placeholder that lets us use the theme's placeholder image -->
                <a href="#" style="text-decoration: none; display: block; position: relative;">
                  <div style="position: relative; height: 280px; width: 280px; padding: 0; background-color: {{ block.settings.image_bg_color }}; margin: 0 auto; aspect-ratio: 1/1; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                    {% if block.settings.placeholder_image %}
                      <img src="{{ block.settings.placeholder_image | image_url: width: 400 }}"
                           alt="Coming Soon" 
                           style="width: auto; height: auto; max-width: 100%; max-height: 100%; object-fit: contain; margin: 0 auto;" 
                           loading="lazy"
                           width="400"
                           height="400">
                    {% else %}
                      <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 18px;">
                        No Image
                      </div>
                    {% endif %}
                  </div>
                  
                  <!-- Product Info Section - Matching regular product cards -->
                  <div style="padding: 12px 12px 12px; border-top: 1px solid #f0f0f0;">
                    <div style="font-size: 15px; font-weight: 500; margin-bottom: 6px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                      {{ block.settings.placeholder_title | default: 'Coming Soon' }}
                    </div>
                    
                    <!-- Price and Button Side by Side - matching regular layout with improved spacing -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 8px;">
                      <div style="display: flex; align-items: baseline; max-width: 60%;">
                        <div style="font-weight: 600; color: {{ block.settings.badge_bg_color }}; font-size: 15px; margin-right: 6px; letter-spacing: -0.01em;">
                          {{ block.settings.placeholder_subtitle | default: 'Stay Tuned' }}
                        </div>
                      </div>
                      
                      <!-- Sold Out Button with smaller styling -->
                      <div style="padding: 4px 8px; 
                               background-color: {{ block.settings.sold_out_button_color | default: '#cccccc' }}; 
                               color: {{ block.settings.button_text_color | default: 'white' }}; 
                               border: none; 
                               border-radius: 4px; 
                               font-weight: 500; 
                               font-size: 10px; 
                               white-space: nowrap;
                               min-width: 60px;
                               max-width: 80px;
                               text-align: center;">
                        {{ block.settings.sold_out_text | default: 'SOLD OUT' }}
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
      
      <!-- Scroll Indicators for Mobile -->
      <div class="scroll-indicators" id="scroll-indicators">
        <!-- Dots will be dynamically generated by JavaScript -->
      </div>
    </div>
    
    {% if counter == 0 and placeholders_needed != desktop_limit %}
      <p style="text-align: center; margin: 50px 0; color: #666;">
        No discounted products available with the selected tag.
      </p>
    {% endif %}
    
    {% if block.settings.show_debug %}
    <div class="debug-info custom-scrollbar">
      <h4>Debug Information</h4>
      <p>Looking for tag: "{{ custom_tag }}"</p>
      <p>Tag handle: "{{ tag_handle }}"</p>
      <p>Collection with tag exists: {% if collections[tag_handle] != blank %}Yes{% else %}No{% endif %}</p>
      <p>Total products checked: {{ total_products }}</p>
      <p>Products with discounts: {{ discounted_products }}</p>
      <p>Products displayed: {{ counter }}</p>
      
      <h4>All Available Tags</h4>
      <div style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto;" class="custom-scrollbar">
        {% assign all_tags = collections.all.products | map: 'tags' | join: ',' | split: ',' | uniq | sort %}
        {% for tag in all_tags %}
          <div style="background: #eee; padding: 5px 10px; border-radius: 4px; margin-bottom: 4px;">{{ tag }}</div>
        {% endfor %}
      </div>

      <h4>Search Options</h4>
      <p>Try using the tags exactly as shown above. You can also try the following approaches:</p>
      <ol>
        <li>Change the tag to use an exact tag from the list above</li>
        <li>Create a collection with the same name as your tag</li>
        <li>Check "Show All Discounted Products" to see all available discounted products</li>
      </ol>
      
      <h4>Test Products</h4>
      <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 10px;" class="custom-scrollbar">
        <p><strong>First 10 products and their tags:</strong></p>
        {% for product in collections.all.products limit: 10 %}
          <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
            <strong>{{ product.title }}</strong><br>
            Tags: 
            {% if product.tags.size > 0 %}
              {% for tag in product.tags %}
                <span style="background: #f5f5f5; padding: 2px 6px; margin-right: 4px; border-radius: 3px; font-size: 11px;">{{ tag }}</span>
              {% endfor %}
            {% else %}
              <em>No tags</em>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
  
  <!-- Simple "Add to cart" functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ps = document.getElementById('products-scroll');
      const si = document.getElementById('scroll-indicators');
      if (!ps || !si) return;
      const slides = ps.querySelectorAll('.product-slide');
      const sc = slides.length;
      if (sc > 0 && window.innerWidth < 768) initMobileSlider(ps, si, slides, sc);
      window.addEventListener('resize', function() {
        if (window.innerWidth < 768) {if (si.children.length === 0 && sc > 0) initMobileSlider(ps, si, slides, sc);
        } else {si.innerHTML = '';}
      });
    });
    
    function initMobileSlider(ps, si, slides, sc) {
      si.innerHTML = '';
      for (let i = 0; i < sc; i++) {
        const dot = document.createElement('span');
        dot.className = 'scroll-dot';
        if (i === 0) dot.classList.add('active');
        dot.dataset.index = i;
        dot.addEventListener('click', function() {
          const index = parseInt(this.dataset.index);
          if (slides[index]) ps.scrollTo({left: slides[index].offsetLeft - ps.offsetLeft, behavior: 'smooth'});
        });
        si.appendChild(dot);
      }
      
      let st;
      ps.addEventListener('scroll', function() {
        if (st) clearTimeout(st);
        st = setTimeout(function() {updateActiveDot(ps, slides);}, 50);
      });
      
      updateActiveDot(ps, slides);
      
      let tsx = 0, tex = 0;
      ps.addEventListener('touchstart', function(e) {tsx = e.touches[0].clientX;}, false);
      ps.addEventListener('touchend', function(e) {
        tex = e.changedTouches[0].clientX;
        if (tex < tsx - 50) slideCarousel('next');
        else if (tex > tsx + 50) slideCarousel('prev');
      }, false);
    }
    
    function updateActiveDot(ps, slides) {
      const dots = document.querySelectorAll('.scroll-dot');
      if (!dots.length) return;
      const sl = ps.scrollLeft;
      const cw = ps.clientWidth;
      let ai = 0, bv = 0;
      
      slides.forEach((slide, i) => {
        const slf = slide.offsetLeft - ps.offsetLeft;
        const sr = slf + slide.offsetWidth;
        const vl = Math.max(0, slf);
        const vr = Math.min(sr, sl + cw);
        const vw = Math.max(0, vr - vl);
        if (vw > bv) {bv = vw; ai = i;}
      });
      
      dots.forEach((dot, i) => {
        if (i === ai) dot.classList.add('active');
        else dot.classList.remove('active');
      });
    }
    
    function slideCarousel(d) {
      const ps = document.getElementById('products-scroll');
      if (!ps) return;
      const sw = ps.querySelector('.product-slide')?.offsetWidth || 240;
      ps.scrollBy({left: d === 'next' ? sw : -sw, behavior: 'smooth'});
    }
    
    function addToCart(vid) {
      const btn = event.target;
      const ot = btn.textContent;
      btn.textContent = 'ADDING...';
      btn.disabled = true;
      
      fetch('/cart/add.js', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
        body: JSON.stringify({id: vid, quantity: 1})
      })
      .then(r => r.json())
      .then(data => {
        btn.textContent = 'ADDED!';
        setTimeout(() => {btn.textContent = ot; btn.disabled = false;}, 2000);
        
        // Get cart drawer section ID
        const cartDrawerSection = document.querySelector('cart-drawer')?.closest('.shopify-section')?.id;
        
        if (cartDrawerSection) {
          const sectionId = cartDrawerSection.replace('shopify-section-', '');
          
          // First fetch the updated cart drawer content
          fetch(`?sections=${sectionId},cart-icon-bubble`)
            .then(response => response.json())
            .then(sections => {
              // Update cart drawer content
              if (sections[sectionId]) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = sections[sectionId];
                const newCartDrawer = tempDiv.querySelector('cart-drawer').innerHTML;
                document.querySelector('cart-drawer').innerHTML = newCartDrawer;
              }
              
              // Update cart icon bubble if available
              if (sections['cart-icon-bubble']) {
                const iconContainer = document.getElementById('cart-icon-bubble');
                if (iconContainer) {
                  iconContainer.innerHTML = sections['cart-icon-bubble'];
                }
              }
              
              // Now open the drawer after content is updated
              setTimeout(() => {
                document.dispatchEvent(new CustomEvent('dispatch:cart-drawer:open'));
              }, 100);
            })
            .catch(error => {
              console.error('Error updating cart sections:', error);
              // Fallback to just opening the drawer
              document.dispatchEvent(new CustomEvent('dispatch:cart-drawer:open'));
            });
        } else {
          // Fallback if we can't find the section
          document.dispatchEvent(new CustomEvent('dispatch:cart-drawer:refresh'));
          setTimeout(() => {
            document.dispatchEvent(new CustomEvent('dispatch:cart-drawer:open'));
          }, 150);
        }
      })
      .catch(e => {
        console.error('Error adding to cart:', e);
        btn.textContent = 'ERROR';
        setTimeout(() => {btn.textContent = ot; btn.disabled = false;}, 2000);
      });
    }
    
    {% if block.settings.autoplay %}
    document.addEventListener('DOMContentLoaded', function() {
      const ps = document.getElementById('products-scroll');
      if (ps && window.innerWidth < 1024) {
        let ci = 0;
        const slides = ps.querySelectorAll('.product-slide');
        const sc = slides.length;
        const sp = {{ block.settings.autoplay_delay }};
        let at = null;
        
        function startAP() {
          if (at) return;
          at = setInterval(function() {
            ci = (ci + 1) % sc;
            const ts = slides[ci];
            if (ts) {
              ps.scrollTo({left: ts.offsetLeft - ps.offsetLeft, behavior: 'smooth'});
              const dots = document.querySelectorAll('.scroll-dot');
              dots.forEach((dot, i) => {
                if (i === ci) dot.classList.add('active');
                else dot.classList.remove('active');
              });
            }
          }, sp);
        }
        
        function pauseAP() {clearInterval(at); at = null;}
        
        ps.addEventListener('mouseenter', pauseAP);
        ps.addEventListener('touchstart', pauseAP);
        if (window.innerWidth < 768) ps.addEventListener('mouseleave', startAP);
        setTimeout(startAP, sp);
        
        window.addEventListener('resize', function() {
          if (window.innerWidth >= 1024) pauseAP();
          else if (!at && window.innerWidth < 768) startAP();
        });
      }
    });
    {% endif %}
  </script>
</div>

{% schema %}
{
  "name": "Product Carousel",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading_text",
      "label": "Heading",
      "default": "Exclusive Deals & Offers"
    },
    {
      "type": "text",
      "id": "subtitle_text",
      "label": "Subtitle",
      "default": "Discover our curated selection of premium products"
    },
    {
      "type": "text",
      "id": "product_tag",
      "label": "Product Tag",
      "default": "DailyDiscount_每日優惠",
      "info": "Show products with this tag"
    },
    {
      "type": "checkbox",
      "id": "show_all_products",
      "label": "Show All Discounted",
      "default": false
    },
    {
      "type": "header",
      "content": "Placeholder Settings"
    },
    {
      "type": "image_picker",
      "id": "placeholder_image",
      "label": "Placeholder Image",
      "info": "Shown when fewer than 8 products are available (400x400px recommended)"
    },
    {
      "type": "text",
      "id": "placeholder_title",
      "label": "Placeholder Title",
      "default": "Coming Soon"
    },
    {
      "type": "text",
      "id": "placeholder_subtitle",
      "label": "Placeholder Subtitle",
      "default": "Stay Tuned"
    },
    {
      "type": "checkbox",
      "id": "show_placeholders",
      "label": "Show Placeholders",
      "default": true
    },
    {
      "type": "color",
      "id": "placeholder_bg_color",
      "label": "Placeholder Background",
      "default": "#f9f9f9"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "subtitle_color",
      "label": "Subtitle Color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "card_bg_color",
      "label": "Card Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "badge_bg_color",
      "label": "Sale Badge Color",
      "default": "#FF385C"
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Button Color",
      "default": "#FF385C"
    },
    {
      "type": "color",
      "id": "button_hover_color",
      "label": "Button Hover Color",
      "default": "#E62B50"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "sold_out_button_color",
      "label": "Sold Out Button Color",
      "default": "#CCCCCC"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Add to Cart Text",
      "default": "加入優惠"
    },
    {
      "type": "text",
      "id": "sold_out_text",
      "label": "Sold Out Text",
      "default": "SOLD OUT"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "image_height",
      "min": 150,
      "max": 350,
      "step": 10,
      "label": "Image Height",
      "default": 260
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable Autoplay",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_delay",
      "min": 1000,
      "max": 9000,
      "step": 1000,
      "label": "Autoplay Delay",
      "default": 3000
    },
    {
      "type": "checkbox",
      "id": "show_debug",
      "label": "Show Debug Info",
      "default": false,
      "info": "Shows troubleshooting information"
    }
  ]
}

{% endschema %}