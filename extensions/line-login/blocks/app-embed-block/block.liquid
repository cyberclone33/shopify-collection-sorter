{% comment %}
  Daily Discounts App Embed Block
  Displays products with the tag "DailyDiscount_每日優惠"
{% endcomment %}

<div id="alpha-dog-daily-discount" class="alpha-dog-daily-discount" data-tag="{{ block.settings.product_tag }}">
  <div class="daily-discount-container">
    <style>
      .alpha-dog-daily-discount {
        margin: {{ block.settings.margin_vertical }}px {{ block.settings.margin_horizontal }}px;
      }
      .daily-discount-container {
        font-family: {{ block.settings.font_family }}, sans-serif;
      }
      .daily-discount-header {
        text-align: center;
        margin-bottom: 20px;
      }
      .daily-discount-header h2 {
        color: {{ block.settings.heading_color }};
        font-size: {{ block.settings.heading_size }}px;
        margin-bottom: 10px;
        font-weight: {{ block.settings.heading_weight }};
      }
      .daily-discount-header p {
        color: {{ block.settings.text_color }};
        font-size: {{ block.settings.subtitle_size }}px;
      }
      .daily-discount-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax({{ block.settings.min_card_width }}px, 1fr));
        gap: {{ block.settings.grid_gap }}px;
      }
      .daily-discount-carousel {
        display: flex;
        overflow-x: auto;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
        padding: 10px 0;
      }
      .daily-discount-carousel .product-card {
        flex: 0 0 {{ block.settings.min_card_width }}px;
        margin-right: {{ block.settings.grid_gap }}px;
        scroll-snap-align: start;
      }
      .daily-discount-list {
        display: flex;
        flex-direction: column;
        gap: {{ block.settings.grid_gap }}px;
      }
      .daily-discount-list .product-card {
        display: flex;
        align-items: center;
      }
      .daily-discount-list .product-image {
        flex: 0 0 100px;
        margin-right: 15px;
      }
      .product-card {
        border: 1px solid {{ block.settings.card_border_color }};
        border-radius: {{ block.settings.card_border_radius }}px;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background-color: {{ block.settings.card_background }};
      }
      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .product-image {
        width: 100%;
        padding-top: 100%;
        position: relative;
        overflow: hidden;
        background-color: #f5f5f5;
      }
      .product-image img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .product-info {
        padding: 15px;
      }
      .product-title {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: {{ block.settings.product_title_size }}px;
        color: {{ block.settings.product_title_color }};
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .variant-title {
        color: {{ block.settings.text_color }};
        font-size: {{ block.settings.variant_title_size }}px;
        margin-bottom: 8px;
      }
      .price-container {
        display: flex;
        align-items: baseline;
        margin-top: 10px;
        flex-wrap: wrap;
      }
      .current-price {
        font-weight: bold;
        color: {{ block.settings.price_color }};
        font-size: {{ block.settings.price_size }}px;
        margin-right: 10px;
      }
      .original-price {
        text-decoration: line-through;
        color: {{ block.settings.compare_price_color }};
        font-size: {{ block.settings.compare_price_size }}px;
      }
      .savings-badge {
        display: inline-block;
        background-color: {{ block.settings.savings_badge_color }};
        color: {{ block.settings.savings_badge_text_color }};
        padding: 3px 8px;
        border-radius: 4px;
        font-size: {{ block.settings.badge_size }}px;
        font-weight: bold;
        margin-top: 8px;
      }
      .loading-indicator {
        text-align: center;
        padding: 20px;
        color: {{ block.settings.text_color }};
      }
      .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: {{ block.settings.heading_color }};
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: discount-spin 1s linear infinite;
        margin: 0 auto;
      }
      @keyframes discount-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .error-message {
        text-align: center;
        color: #d9534f;
        padding: 15px;
      }
      .countdown-timer {
        text-align: center;
        margin-bottom: 15px;
        color: {{ block.settings.timer_color }};
        font-size: {{ block.settings.timer_size }}px;
        font-weight: bold;
      }
      .countdown-timer span {
        display: inline-block;
        background-color: {{ block.settings.timer_background }};
        color: {{ block.settings.timer_text_color }};
        padding: 5px 10px;
        border-radius: 4px;
        margin: 0 3px;
        min-width: 40px;
      }
      .countdown-label {
        font-size: {{ block.settings.timer_label_size }}px;
        color: {{ block.settings.timer_color }};
        display: block;
        margin-top: 5px;
      }
      .stock-info {
        margin-top: 8px;
        font-size: {{ block.settings.stock_text_size }}px;
        color: {{ block.settings.stock_text_color }};
      }
      .stock-low {
        color: {{ block.settings.stock_low_color }};
      }
      
      @media (max-width: 768px) {
        .daily-discount-grid {
          grid-template-columns: repeat(auto-fill, minmax({{ block.settings.min_card_width_mobile }}px, 1fr));
          gap: {{ block.settings.grid_gap_mobile }}px;
        }
        .daily-discount-carousel .product-card {
          flex: 0 0 {{ block.settings.min_card_width_mobile }}px;
        }
        .daily-discount-header h2 {
          font-size: {{ block.settings.heading_size_mobile }}px;
        }
        .daily-discount-header p {
          font-size: {{ block.settings.subtitle_size_mobile }}px;
        }
      }
    </style>

    <div class="daily-discount-header">
      <h2>{{ block.settings.heading_text }}</h2>
      {% if block.settings.show_subtitle %}
        <p>{{ block.settings.subtitle_text }}</p>
      {% endif %}
      
      {% if block.settings.show_countdown %}
        <div class="countdown-timer" id="daily-discount-countdown">
          <span id="countdown-days">00</span>:
          <span id="countdown-hours">00</span>:
          <span id="countdown-minutes">00</span>:
          <span id="countdown-seconds">00</span>
          <div class="countdown-label">{{ block.settings.countdown_label }}</div>
        </div>
      {% endif %}
    </div>

    <div class="daily-discount-products-container 
      {% if block.settings.layout == 'grid' %}daily-discount-grid
      {% elsif block.settings.layout == 'carousel' %}daily-discount-carousel
      {% else %}daily-discount-list{% endif %}"
    >
      {% assign custom_tag = block.settings.product_tag | default: 'DailyDiscount_每日優惠' %}
      {% assign max_products = block.settings.max_products | default: 4 %}
      {% assign sort_by = block.settings.sort_by | default: 'created-descending' %}
      {% assign show_savings = block.settings.show_savings %}
      {% assign show_stock = block.settings.show_stock_level %}
      {% assign low_stock_threshold = block.settings.low_stock_threshold %}
      
      {% case sort_by %}
        {% when 'newest' %}
          {% assign sort_option = 'created-descending' %}
        {% when 'highest_discount' %}
          {% assign sort_option = 'price-descending' %}
        {% when 'lowest_price' %}
          {% assign sort_option = 'price-ascending' %}
        {% else %}
          {% assign sort_option = 'created-descending' %}
      {% endcase %}
      
      {% if custom_tag != blank %}
        {% assign counter = 0 %}
        {% assign tagged_products = collections.all.products | where: "tags", custom_tag | sort: sort_option %}
        
        {% if tagged_products.size > 0 %}
          {% for product in tagged_products %}
            {% if counter < max_products %}
              {% assign current_variant = product.selected_or_first_available_variant %}
              {% if current_variant.compare_at_price > current_variant.price %}
                {% assign savings_amount = current_variant.compare_at_price | minus: current_variant.price %}
                {% assign savings_percentage = savings_amount | times: 100 | divided_by: current_variant.compare_at_price | round %}
                
                <div class="product-card">
                  <a href="{{ product.url }}{% if current_variant.id != product.variants.first.id %}?variant={{ current_variant.id }}{% endif %}">
                    <div class="product-image">
                      {% if product.featured_image %}
                        {% assign img_src = product.featured_image | image_url: width: 400, height: 400, crop: 'center' %}
                        <img 
                          src="{{ img_src }}" 
                          alt="{{ product.title }}" 
                          width="400" 
                          height="400"
                          loading="lazy"
                        >
                      {% else %}
                        <div style="width:100%;height:100%;background-color:#f5f5f5;display:flex;align-items:center;justify-content:center;">
                          <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                          </svg>
                        </div>
                      {% endif %}
                    </div>
                    <div class="product-info">
                      <div class="product-title">{{ product.title }}</div>
                      {% if current_variant.title != 'Default Title' %}
                        <div class="variant-title">{{ current_variant.title }}</div>
                      {% endif %}
                      <div class="price-container">
                        <div class="current-price">{{ current_variant.price | money }}</div>
                        <div class="original-price">{{ current_variant.compare_at_price | money }}</div>
                      </div>
                      {% if show_savings %}
                        <div class="savings-badge">{{ block.settings.savings_text }} {{ savings_percentage }}%</div>
                      {% endif %}
                      
                      {% if show_stock %}
                        <div class="stock-info {% if current_variant.inventory_quantity <= low_stock_threshold and current_variant.inventory_quantity > 0 %}stock-low{% endif %}">
                          {% if current_variant.inventory_quantity <= 0 %}
                            {{ block.settings.out_of_stock_text }}
                          {% elsif current_variant.inventory_quantity <= low_stock_threshold %}
                            {{ block.settings.low_stock_text }} {{ current_variant.inventory_quantity }}
                          {% else %}
                            {{ block.settings.in_stock_text }}
                          {% endif %}
                        </div>
                      {% endif %}
                    </div>
                  </a>
                </div>
                {% assign counter = counter | plus: 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {% if counter == 0 %}
            <div class="error-message">{{ block.settings.no_products_text }}</div>
          {% endif %}
        {% else %}
          <div class="error-message">{{ block.settings.no_products_text }}</div>
        {% endif %}
      {% else %}
        <div class="error-message">{{ block.settings.tag_missing_text }}</div>
      {% endif %}
    </div>
  </div>
</div>

{% if block.settings.show_countdown %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Set the end time (default is end of today)
    var endDate = new Date();
    {% if block.settings.custom_end_time %}
      // Parse the custom end time from settings (format: YYYY-MM-DDThh:mm)
      var customEndTime = "{{ block.settings.end_time }}";
      if (customEndTime) {
        endDate = new Date(customEndTime);
      } else {
        // Default to end of today
        endDate.setHours(23, 59, 59, 999);
      }
    {% else %}
      // Default to end of today
      endDate.setHours(23, 59, 59, 999);
    {% endif %}
    
    function updateCountdown() {
      var now = new Date();
      var timeLeft = endDate - now;
      
      if (timeLeft <= 0) {
        // Time has expired
        document.getElementById('countdown-days').textContent = '00';
        document.getElementById('countdown-hours').textContent = '00';
        document.getElementById('countdown-minutes').textContent = '00';
        document.getElementById('countdown-seconds').textContent = '00';
        return;
      }
      
      // Calculate days, hours, minutes, seconds
      var days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
      var hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      var minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
      var seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
      
      // Add leading zeros
      days = days < 10 ? '0' + days : days;
      hours = hours < 10 ? '0' + hours : hours;
      minutes = minutes < 10 ? '0' + minutes : minutes;
      seconds = seconds < 10 ? '0' + seconds : seconds;
      
      // Update the display
      document.getElementById('countdown-days').textContent = days;
      document.getElementById('countdown-hours').textContent = hours;
      document.getElementById('countdown-minutes').textContent = minutes;
      document.getElementById('countdown-seconds').textContent = seconds;
    }
    
    // Update the countdown every second
    updateCountdown();
    setInterval(updateCountdown, 1000);
  });
</script>
{% endif %}

{% schema %}
{
  "name": "Daily Discounts",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Product Settings"
    },
    {
      "type": "text",
      "id": "product_tag",
      "label": "Product Tag",
      "default": "DailyDiscount_每日優惠",
      "info": "Enter the tag used to identify products to display in this section"
    },
    {
      "type": "range",
      "id": "max_products",
      "min": 1,
      "max": 20,
      "step": 1,
      "label": "Maximum Products to Display",
      "default": 4
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Layout Style",
      "options": [
        {
          "value": "grid",
          "label": "Grid"
        },
        {
          "value": "carousel",
          "label": "Carousel"
        },
        {
          "value": "list",
          "label": "List"
        }
      ],
      "default": "grid"
    },
    {
      "type": "select",
      "id": "sort_by",
      "label": "Sort Products By",
      "options": [
        {
          "value": "newest",
          "label": "Most Recent Discounts"
        },
        {
          "value": "highest_discount",
          "label": "Highest Discount"
        },
        {
          "value": "lowest_price",
          "label": "Lowest Price"
        }
      ],
      "default": "newest"
    },
    {
      "type": "header",
      "content": "Display Settings"
    },
    {
      "type": "text",
      "id": "heading_text",
      "label": "Heading Text",
      "default": "Today's Special Discounts"
    },
    {
      "type": "checkbox",
      "id": "show_subtitle",
      "label": "Show Subtitle",
      "default": true
    },
    {
      "type": "text",
      "id": "subtitle_text",
      "label": "Subtitle Text",
      "default": "Limited time offers on today's featured products"
    },
    {
      "type": "checkbox",
      "id": "show_savings",
      "label": "Show Savings Badge",
      "default": true
    },
    {
      "type": "text",
      "id": "savings_text",
      "label": "Savings Badge Text",
      "default": "Save"
    },
    {
      "type": "checkbox",
      "id": "show_stock_level",
      "label": "Show Stock Level",
      "default": true
    },
    {
      "type": "range",
      "id": "low_stock_threshold",
      "min": 1,
      "max": 20,
      "step": 1,
      "label": "Low Stock Threshold",
      "default": 5,
      "info": "Show 'Low Stock' warning when inventory falls below this number"
    },
    {
      "type": "text",
      "id": "in_stock_text",
      "label": "In Stock Text",
      "default": "In Stock"
    },
    {
      "type": "text",
      "id": "low_stock_text",
      "label": "Low Stock Text",
      "default": "Only"
    },
    {
      "type": "text",
      "id": "out_of_stock_text",
      "label": "Out of Stock Text",
      "default": "Sold Out"
    },
    {
      "type": "header",
      "content": "Countdown Timer"
    },
    {
      "type": "checkbox",
      "id": "show_countdown",
      "label": "Show Countdown Timer",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "custom_end_time",
      "label": "Use Custom End Time",
      "default": false,
      "info": "By default, countdown ends at midnight today"
    },
    {
      "type": "datetime",
      "id": "end_time",
      "label": "Custom End Time",
      "info": "Select the date and time when the discount offer ends"
    },
    {
      "type": "text",
      "id": "countdown_label",
      "label": "Countdown Label",
      "default": "Offer ends in"
    },
    {
      "type": "header",
      "content": "Style Settings"
    },
    {
      "type": "range",
      "id": "margin_vertical",
      "min": 0,
      "max": 100,
      "step": 5,
      "label": "Vertical Margin",
      "default": 30
    },
    {
      "type": "range",
      "id": "margin_horizontal",
      "min": 0,
      "max": 100,
      "step": 5,
      "label": "Horizontal Margin",
      "default": 0
    },
    {
      "type": "range",
      "id": "grid_gap",
      "min": 10,
      "max": 50,
      "step": 5,
      "label": "Grid Gap",
      "default": 20
    },
    {
      "type": "range",
      "id": "grid_gap_mobile",
      "min": 5,
      "max": 30,
      "step": 5,
      "label": "Grid Gap (Mobile)",
      "default": 15
    },
    {
      "type": "range",
      "id": "min_card_width",
      "min": 150,
      "max": 400,
      "step": 10,
      "label": "Min Card Width",
      "default": 250
    },
    {
      "type": "range",
      "id": "min_card_width_mobile",
      "min": 120,
      "max": 250,
      "step": 10,
      "label": "Min Card Width (Mobile)",
      "default": 160
    },
    {
      "type": "select",
      "id": "font_family",
      "label": "Font Family",
      "default": "inherit",
      "options": [
        {
          "value": "inherit",
          "label": "Theme Default"
        },
        {
          "value": "Arial",
          "label": "Arial"
        },
        {
          "value": "Helvetica",
          "label": "Helvetica"
        },
        {
          "value": "Times New Roman",
          "label": "Times New Roman"
        },
        {
          "value": "Georgia",
          "label": "Georgia"
        }
      ]
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#333333"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 16,
      "max": 48,
      "step": 1,
      "label": "Heading Size",
      "default": 28
    },
    {
      "type": "range",
      "id": "heading_size_mobile",
      "min": 14,
      "max": 32,
      "step": 1,
      "label": "Heading Size (Mobile)",
      "default": 24
    },
    {
      "type": "select",
      "id": "heading_weight",
      "label": "Heading Weight",
      "default": "700",
      "options": [
        {
          "value": "400",
          "label": "Regular"
        },
        {
          "value": "500",
          "label": "Medium"
        },
        {
          "value": "600",
          "label": "Semibold"
        },
        {
          "value": "700",
          "label": "Bold"
        }
      ]
    },
    {
      "type": "range",
      "id": "subtitle_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "label": "Subtitle Size",
      "default": 16
    },
    {
      "type": "range",
      "id": "subtitle_size_mobile",
      "min": 12,
      "max": 20,
      "step": 1,
      "label": "Subtitle Size (Mobile)",
      "default": 14
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "card_background",
      "label": "Card Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "card_border_color",
      "label": "Card Border Color",
      "default": "#e8e8e8"
    },
    {
      "type": "range",
      "id": "card_border_radius",
      "min": 0,
      "max": 20,
      "step": 1,
      "label": "Card Border Radius",
      "default": 8
    },
    {
      "type": "color",
      "id": "product_title_color",
      "label": "Product Title Color",
      "default": "#333333"
    },
    {
      "type": "range",
      "id": "product_title_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "label": "Product Title Size",
      "default": 16
    },
    {
      "type": "range",
      "id": "variant_title_size",
      "min": 10,
      "max": 18,
      "step": 1,
      "label": "Variant Title Size",
      "default": 14
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Price Color",
      "default": "#ff6b6b"
    },
    {
      "type": "range",
      "id": "price_size",
      "min": 14,
      "max": 24,
      "step": 1,
      "label": "Price Size",
      "default": 18
    },
    {
      "type": "color",
      "id": "compare_price_color",
      "label": "Compare Price Color",
      "default": "#999999"
    },
    {
      "type": "range",
      "id": "compare_price_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "label": "Compare Price Size",
      "default": 14
    },
    {
      "type": "color",
      "id": "savings_badge_color",
      "label": "Savings Badge Color",
      "default": "#ff6b6b"
    },
    {
      "type": "color",
      "id": "savings_badge_text_color",
      "label": "Savings Badge Text Color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "badge_size",
      "min": 10,
      "max": 16,
      "step": 1,
      "label": "Badge Size",
      "default": 12
    },
    {
      "type": "color",
      "id": "stock_text_color",
      "label": "Stock Text Color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "stock_low_color",
      "label": "Low Stock Text Color",
      "default": "#e67e22"
    },
    {
      "type": "range",
      "id": "stock_text_size",
      "min": 10,
      "max": 16,
      "step": 1,
      "label": "Stock Text Size",
      "default": 12
    },
    {
      "type": "color",
      "id": "timer_color",
      "label": "Timer Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "timer_background",
      "label": "Timer Background",
      "default": "#f5f5f5"
    },
    {
      "type": "color",
      "id": "timer_text_color",
      "label": "Timer Text Color",
      "default": "#333333"
    },
    {
      "type": "range",
      "id": "timer_size",
      "min": 14,
      "max": 28,
      "step": 1,
      "label": "Timer Size",
      "default": 20
    },
    {
      "type": "range",
      "id": "timer_label_size",
      "min": 12,
      "max": 18,
      "step": 1,
      "label": "Timer Label Size",
      "default": 14
    },
    {
      "type": "header",
      "content": "Message Settings"
    },
    {
      "type": "text",
      "id": "no_products_text",
      "label": "No Products Message",
      "default": "No discounted products available at the moment."
    },
    {
      "type": "text",
      "id": "tag_missing_text",
      "label": "Tag Missing Message",
      "default": "Please specify a product tag in the settings."
    }
  ]
}
{% endschema %}