{% comment %}
  This snippet processes LINE login requests and handles authentication using Shopify's Storefront API
  Using the form trick for standard Shopify stores
{% endcomment %}

{% if request.path contains '/account/login' and request.params.line_login == 'success' %}
  <div class="line-login-debug" style="
    background: #f5f5f5;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
    font-family: monospace;
  ">
    <h3>Debug Info:</h3>
    <p>Email: {{ request.params.customer_email }}</p>
    <p>Access Token: {{ request.params.access_token }}</p>
    <p>LINE ID: {{ request.params.line_id }}</p>
  </div>

  <!-- Visible form for Shopify login -->
  <form id="shopify-auto-login" method="post" action="/account/login" style="
    background: white;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin: 20px 0;
  ">
    <div style="margin-bottom: 15px;">
      <label for="customer_email" style="display: block; margin-bottom: 5px;">Email</label>
      <input type="email" 
             name="customer[email]" 
             id="customer_email" 
             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
      >
    </div>
    
    <div style="margin-bottom: 15px;">
      <label for="customer_password" style="display: block; margin-bottom: 5px;">Password (LINE Token)</label>
      <input type="password" 
             name="customer[password]" 
             id="customer_password"
             style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
      >
    </div>

    <input type="hidden" name="form_type" value="customer_login">
    <input type="hidden" name="utf8" value="âœ“">
    
    <button type="submit" style="
      background: #06C755;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    ">Complete LINE Login</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const customerEmail = '{{ request.params.customer_email }}';
      const lineUserId = '{{ request.params.line_id }}';
      const accessToken = '{{ request.params.access_token }}';
      
      console.log('Debug - Received parameters:', {
        customerEmail,
        lineUserId,
        accessToken
      });
      
      try {
        // First show a loading message to indicate we're processing
        const infoMessage = document.createElement('div');
        infoMessage.className = 'line-login-info-message';
        infoMessage.innerHTML = `
          <style>
            .line-login-info-message {
              background-color: #f0f8f0;
              border: 1px solid #06C755;
              border-radius: 4px;
              padding: 15px;
              margin-bottom: 20px;
              text-align: center;
              color: #222;
            }
            .line-login-info-message h3 {
              color: #06C755;
              margin-top: 0;
            }
            .line-brand {
              color: #06C755;
              font-weight: bold;
            }
          </style>
          <h3>{{ 'line_login.handler.login_success' | t }}</h3>
          <p>{{ 'line_login.handler.logging_in' | t }}</p>
        `;

        // Insert message before the login form
        const loginForm = document.querySelector('#shopify-auto-login');
        if (loginForm) {
          loginForm.parentNode.insertBefore(infoMessage, loginForm);
        }
        
        // If we have all the necessary parameters, fill the form
        if (customerEmail && accessToken) {
          console.log('Debug - Filling form with:', {
            email: customerEmail,
            token: accessToken.substring(0, 5) + '...' // Only log first 5 chars for security
          });
          
          // Fill the form
          document.getElementById('customer_email').value = customerEmail;
          document.getElementById('customer_password').value = accessToken;
          
          // Auto-submit after a short delay (to show the form being filled)
          setTimeout(() => {
            console.log('Debug - Auto-submitting form...');
            document.getElementById('shopify-auto-login').submit();
          }, 1500);
        } else {
          console.error('Debug - Missing required parameters');
          throw new Error('Missing required parameters');
        }
      } catch (error) {
        console.error('LINE login error:', error);
        // Show error message
        const errorMessage = document.createElement('div');
        errorMessage.className = 'line-login-error-message';
        errorMessage.innerHTML = `
          <style>
            .line-login-error-message {
              background-color: #fff0f0;
              border: 1px solid #ff4444;
              border-radius: 4px;
              padding: 15px;
              margin-bottom: 20px;
              text-align: center;
              color: #222;
            }
          </style>
          <p>{{ 'line_login.handler.login_error' | t }}</p>
          <p style="font-size: 0.9em; color: #666;">Error: ${error.message}</p>
        `;
        
        const loginForm = document.querySelector('#shopify-auto-login');
        if (loginForm) {
          loginForm.parentNode.insertBefore(errorMessage, loginForm);
        }
      }
    });
  </script>
{% endif %}
